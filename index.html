<html>
    <head>
        <title>Ethereum Wallet</title>
    </head>
    <body>
      <div id="step1">
        <h1>Import your JSON key</h1>
        <input type="file" id="walletFile" />
        <input type="password" id="walletPassword" />
        <button type="submit" id="walletSubmit">Submit</button>

        <div id="WalletConnectionStatus"></div>
      </div>

      <div id="step2" style="display: none">
        <h1>Connected!</h1>
        <p>Adress: <span id="walletAddress">...</span></p>
        <p>Balance: <span id="walletBalance">...</span></p>

        <h2>Transaction</h2>
        <input type="text" id="transactionToAddress" placeholder="To (Wallet address)"/>
        <input type="text" id="transactionAmount" placeholder="Value (Ether)" />
        <button type="submit" id="transactionSubmit">Submit</button>

        <h2>Contract</h2>
        <input type="file" id="contractFile" />
        <button type="submit" id="contractSubmit">Submit</button>
      </div>

      <script charset="utf-8"
        src="https://cdn.ethers.io/scripts/ethers-v2.min.js"
        type="text/javascript">
      </script>

      <script type="text/javascript">
        var Provider = {
          token: '', // need token? go to infura.io
          network: ethers.providers.networks.rinkeby,

          get: function() {
            return new ethers.providers.InfuraProvider(this.network, this.token);
          }
        };

        var Wallet = {
            activeWallet: null,

            inputFile: document.querySelector('#walletFile'),
            inputPasswd: document.querySelector('#walletPassword'),
            inputSubmit: document.querySelector('#walletSubmit'),
            statusWrapper: document.querySelector('#WalletConnectionStatus'),
            addressWrapper: document.querySelector('#walletAddress'),
            balanceWrapper: document.querySelector('#walletBalance'),

            init: function() {
              this.inputSubmit.addEventListener('click', this.import, false);
            },

            import: function() {
              var file = Wallet.inputFile.files[0];

              var reader = new FileReader();
              reader.onload = function(e) {
                Wallet.unlock(e.target.result)
              }

              reader.readAsText(file);
            },

            unlock: function(data) {
              var password = this.inputPasswd.value;

              Wallet.statusWrapper.innerHTML = "Connecting..."

              // Opening wallet
              var walletPromise = ethers.Wallet.fromEncryptedWallet(data, password).then(function(wallet) {
                // Bad code, but who cares?
                document.querySelector('#step1').style.display = 'none';
                document.querySelector('#step2').style.display = 'block';

                Wallet.activeWallet = wallet;
                Wallet.activeWallet.provider = Provider.get();

                Wallet.addressWrapper.innerHTML = Wallet.activeWallet.address;

                Wallet.updateBalance();
              }).catch(function(e) {
                Wallet.statusWrapper.innerHTML = e;
              })
            },

            updateBalance: function() {
              Provider.get().getBalance(this.activeWallet.address).then(function(balance) {
                var etherBalance = ethers.utils.formatEther(balance);
                Wallet.balanceWrapper.innerHTML = etherBalance;
              });
            }
        };

        var Transaction = {
          inputSubmit: document.querySelector('#transactionSubmit'),
          inputAddress: document.querySelector('#transactionToAddress'),
          inputAmount: document.querySelector('#transactionAmount'),

          init: function() {
            this.inputSubmit.addEventListener('click', this.send, false);
          },

          send: function() {
            var targetAddress = ethers.utils.getAddress(this.inputAddress.value);
            var amountWei = ethers.utils.parseEther(this.inputAmount.value);

            Wallet.activeWallet.send(targetAddress, amountWei).then(function() {
                alert('Success!');
            });
          }
        };

        var Contract = {
          activeContract: null,
          abi: null,

          inputFile: document.querySelector('#contractFile'),
          inputSubmit: document.querySelector('#contractSubmit'),

          init: function() {
            this.inputSubmit.addEventListener('click', this.import, false);
          },

          import: function() {
            var file = Contract.inputFile.files[0];

            var reader = new FileReader();
            reader.onload = function(e) {
              Contract.abi = JSON.parse(e.target.result).abi;
              Contract.send();
            }

            reader.readAsText(file);
          },

          send: function() {
            console.log(Contract.abi);
            this.activeContract = new ethers.Contract(Wallet.activeWallet.address, Contract.abi, Provider.get());
          }
        };

        Wallet.init();
        Transaction.init();
        Contract.init();
      </script>
    </body>
</html>
